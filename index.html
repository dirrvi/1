// script.js

const app = document.getElementById("app");

let state = {
  currentPage: "rules",
  block: 1,
  subjectIndex: 0,
  answers: {
    "Українська мова": [],
    "Математика": [],
    "Історія України": [],
    "Англійська мова": []
  },
  completed: {},
  currentSubject: null
};

const subjects = {
  1: ["Українська мова", "Математика"],
  2: ["Історія України", "Англійська мова"]
};

const questions = {
  "Українська мова": Array.from({ length: 12 }, (_, i) => ({
    question: `Питання ${i + 1} з української мови?`,
    options: ["Варіант А", "Варіант Б", "Варіант В", "Варіант Г"],
    correct: 0
  })),
  "Математика": Array.from({ length: 12 }, (_, i) => ({
    question: `Приклад ${i + 1} з математики?`,
    options: ["1", "2", "3", "4"],
    correct: 1
  })),
  "Історія України": Array.from({ length: 12 }, (_, i) => ({
    question: `Питання ${i + 1} з історії України?`,
    options: ["1709", "1918", "1991", "1648"],
    correct: 2
  })),
  "Англійська мова": Array.from({ length: 12 }, (_, i) => ({
    question: `Question ${i + 1} in English?`,
    options: ["Option A", "Option B", "Option C", "Option D"],
    correct: 3
  }))
};

function render() {
  if (state.currentPage === "rules") {
    app.innerHTML = `
      <div class="page">
        <h2>Правила тестування</h2>
        <p>Ознайомтесь з інструкціями перед початком.</p>
        <button onclick="nextPage('access1')">З правилами ознайомився/лась</button>
      </div>
    `;
  } else if (state.currentPage === "access1") {
    app.innerHTML = `
      <div class="page">
        <h2>Введіть код доступу до 1 блоку</h2>
        <input id="access-code1" placeholder="Введіть код (54)" />
        <br />
        <button onclick="checkAccessCode('54', 'start1')">Розпочати роботу над тестуванням</button>
      </div>
    `;
  } else if (state.currentPage === "start1") {
    app.innerHTML = `
      <div class="page">
        <button onclick="startTestBlock(1)">Перейти до тесту</button>
      </div>
    `;
  } else if (state.currentPage === "test") {
    const subjectsBlock = subjects[state.block];
    const current = subjectsBlock[state.subjectIndex];
    const qs = questions[current];
    const userAnswers = state.answers[current];
    const tabs = subjectsBlock.map((s, i) => `<div class="tab ${i === state.subjectIndex ? 'active' : ''}" onclick="switchSubject(${i})">${s}</div>`).join('');
    const questionsHTML = qs.map((q, i) => `
      <div class="question">
        <strong>${q.question}</strong><br />
        ${q.options.map((opt, j) => `
          <label><input type="radio" name="q${i}" value="${j}" ${userAnswers[i] == j ? 'checked' : ''} onchange="selectAnswer('${current}', ${i}, ${j})" /> ${opt}</label><br />
        `).join('')}
      </div>
    `).join('');

    app.innerHTML = `
      <div class="page">
        <div class="tabs">${tabs}</div>
        <div class="tab-content">${questionsHTML}</div>
        <button onclick="confirmFinish()">Завершити тестування</button>
      </div>
    `;
  } else if (state.currentPage === "summary1") {
    const allSubjects = subjects[1].concat(subjects[2]);
    const tableRows = allSubjects.map(subj => {
      const answered = state.answers[subj]?.filter(a => a !== undefined).length || 0;
      const result = subjects[1].includes(subj) ? '' : 'До виконання не приступив';
      return `<tr><td>${subj}</td><td>${answered}</td><td>${result}</td></tr>`;
    }).join('');
    app.innerHTML = `
      <div class="page">
        <h2>Проміжні результати</h2>
        <table class="results-table">
          <tr><th>Предмет</th><th>К-сть відповідей</th><th>Результат</th></tr>
          ${tableRows}
        </table>
        <button onclick="nextPage('access2')">Перейти на другий блок</button>
      </div>
    `;
  } else if (state.currentPage === "access2") {
    app.innerHTML = `
      <div class="page">
        <h2>Код доступу до 2 блоку</h2>
        <input id="access-code2" placeholder="Введіть код (29)" />
        <br />
        <button onclick="checkAccessCode('29', 'start2')">Розпочати</button>
      </div>
    `;
  } else if (state.currentPage === "start2") {
    app.innerHTML = `
      <div class="page">
        <button onclick="startTestBlock(2)">Перейти до тесту</button>
      </div>
    `;
  } else if (state.currentPage === "summary2") {
    const allSubjects = subjects[1].concat(subjects[2]);
    const tableRows = allSubjects.map(subj => {
      const answered = state.answers[subj]?.filter(a => a !== undefined).length || 0;
      const score = Math.round((answered / 12) * 12);
      return `<tr>
        <td>${subj}</td>
        <td>${answered}</td>
        <td class="col3-green">${score} / 12</td>
      </tr>`;
    }).join('');

    app.innerHTML = `
      <div class="page">
        <h2>Результати</h2>
        <table class="results-table">
          <tr><th>Предмет</th><th>К-сть відповідей</th><th>Результат</th></tr>
          ${tableRows}
        </table>
        <button onclick="viewAnswers()">Переглянути відповіді</button>
      </div>
    `;
  } else if (state.currentPage === "answers") {
    const allSubjects = subjects[1].concat(subjects[2]);
    const answersHTML = allSubjects.map(subj => {
      const qList = questions[subj];
      const aList = state.answers[subj] || [];
      return `
        <div>
          <h3>${subj}</h3>
          ${qList.map((q, i) => `
            <div>
              <strong>${q.question}</strong><br />
              Ваша відповідь: ${q.options[aList[i]] || 'не обрано'}<br />
              Правильна відповідь: ${q.options[q.correct]}
            </div>
          `).join('<hr>')}
        </div>
      `;
    }).join('<hr>');

    app.innerHTML = `<div class="page">${answersHTML}</div>`;
  }
}

function nextPage(page) {
  state.currentPage = page;
  render();
}

function checkAccessCode(correctCode, nextPageName) {
  const code = document.querySelector("input").value;
  if (code === correctCode) {
    nextPage(nextPageName);
  } else {
    alert("Невірний код!");
  }
}

function startTestBlock(blockNumber) {
  state.block = blockNumber;
  state.subjectIndex = 0;
  state.currentPage = "test";
  render();
}

function switchSubject(index) {
  state.subjectIndex = index;
  render();
}

function selectAnswer(subject, questionIndex, optionIndex) {
  if (!state.answers[subject]) state.answers[subject] = [];
  state.answers[subject][questionIndex] = optionIndex;
}

function confirmFinish() {
  if (confirm("Ви точно хочете завершити роботу над тестуванням?")) {
    if (state.block === 1) {
      state.currentPage = "summary1";
    } else {
      state.currentPage = "summary2";
    }
    render();
  }
}

function viewAnswers() {
  state.currentPage = "answers";
  render();
}

render();
